<div class="columns is-multiline">
    <div class="column is-half">
        <div id="graph-cpu" class="graph-box"></div>
    </div>
    <div class="column is-half">
        <div id="graph-mem" class="graph-box"></div>
    </div>
    <div class="column is-half">
        <div id="graph-disk" class="graph-box"></div>
    </div>
    <div class="column is-half">
        <div id="graph-temp" class="graph-box"></div>
    </div>
</div>

<script>
    (async function loadAndInitGraph() {
      // Load uPlot JS and CSS dynamically
      if (typeof uPlot === "undefined") {
        const script = document.createElement("script");
        script.src = "https://cdn.jsdelivr.net/npm/uplot@1.6.21/dist/uPlot.iife.min.js";
        document.head.appendChild(script);
        await new Promise(resolve => script.onload = resolve);
      }

      if (!document.getElementById("uplot-css")) {
        const css = document.createElement("link");
        css.id = "uplot-css";
        css.rel = "stylesheet";
        css.href = "https://cdn.jsdelivr.net/npm/uplot@1.6.21/dist/uPlot.min.css";
        document.head.appendChild(css);
      }

      const timeData = [Date.now()];
      const maxPoints = 60;
      const dataCPU = [0], dataMEM = [0], dataDISK = [0], dataTEMP = [0];

      function createGraph(id, title, stroke, dataSeries) {
        const el = document.getElementById(id);
        const width = el.offsetWidth || 400;
        return new uPlot({
          title,
          width,
          height: 300,
          scales: { x: { time: true }, y: { auto: true } },
          series: [{}, { label: title, stroke }],
          cursor: { x: true, y: true },
          legend: { show: false }
        }, [timeData, dataSeries], el);
      }

      const uCPU  = createGraph("graph-cpu", "CPU %",     "red",    dataCPU);
      const uMEM  = createGraph("graph-mem", "Memory MB", "blue",   dataMEM);
      const uDISK = createGraph("graph-disk","Disk GB",   "green",  dataDISK);
      const uTEMP = createGraph("graph-temp","Temp Â°C",   "orange", dataTEMP);

      const sse = new EventSource("/plugin/about/graph");
      sse.onmessage = e => {
        const { ts, cpu, mem, disk, temp } = JSON.parse(e.data);
        timeData.push(ts);
        dataCPU.push(cpu);
        dataMEM.push(mem);
        dataDISK.push(disk);
        dataTEMP.push(temp);

        if (timeData.length > maxPoints) {
          timeData.shift();
          dataCPU.shift();
          dataMEM.shift();
          dataDISK.shift();
          dataTEMP.shift();
        }

        uCPU.setData([timeData, dataCPU]);
        uMEM.setData([timeData, dataMEM]);
        uDISK.setData([timeData, dataDISK]);
        uTEMP.setData([timeData, dataTEMP]);
      };

      // Clean up SSE when removed from DOM
      const observer = new MutationObserver(() => {
        if (!document.body.contains(document.getElementById("graph-cpu"))) {
          sse.close();
          observer.disconnect();
        }
      });
      observer.observe(document.body, { childList: true, subtree: true });
    })();
</script>
